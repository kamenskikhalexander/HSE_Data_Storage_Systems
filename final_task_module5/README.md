# Системы хранения данных — Итоговое задание по модулю 5

Данный репозиторий содержит материалы для итогового задания модуля 5 по дисциплине "Системы хранения данных": проектирование и создание хранилища данных в модели Data Vault 2.0 с использованием СУБД GreenPlum для анализа продаж из датасета SampleSuperstore. 

### Содержание репозитория

1.  **Исходный датасет**
    Файл `SampleSuperstore.csv` содержит обрабатываемый датасет с Kaggle.

2.  **ER диаграмма хранилища Data Vault**
   ![Диаграмма](https://github.com/kamenskikhalexander/HSE_Data_Storage_Systems/blob/main/final_task_module5/SampleSuperstore_DV.png)

    ---
    Диаграмма также приложена в файле `SampleSuperstore_DV.png`

3.  **Код для генерации схемы**
    Код для генерации схемы хранилища данных находится в файле `ER_diagram_code.txt`.
    
4.  **SQL-скрипты**
    Файл `create_tables.sql` содержит SQL-скрипты для создания таблиц хранилища и схему `student22` в GreenPlum.


### Компоненты Data Vault

#### Таблицы Хабы (Hubs)

hub_sale
| Имя поля | Тип данных | Обязательность | Значение по умолчанию | Партицирование | Бизнес-описание |
|----------|------------|----------------|----------------------|----------------|-----------------|
| sale_sk | TEXT | NOT NULL | - | - | Суррогатный ключ продажи (хэш бизнес-ключа) |
| sale_id | INT | NULL | - | - | Идентификатор продажи из исходной системы |
| load_datetime | TIMESTAMP | NULL | CURRENT_TIMESTAMP | - | Дата и время загрузки записи в хранилище |
| source | TEXT | NULL | - | - | Источник данных (система-источник) |

hub_product
| Имя поля | Тип данных | Обязательность | Значение по умолчанию | Партицирование | Бизнес-описание |
|----------|------------|----------------|----------------------|----------------|-----------------|
| product_sk | TEXT | NOT NULL | - | - | Суррогатный ключ продукта (хэш бизнес-ключа) |
| product_id | INT | NULL | - | - | Идентификатор продукта из исходной системы |
| load_datetime | TIMESTAMP | NULL | CURRENT_TIMESTAMP | - | Дата и время загрузки записи в хранилище |
| source | TEXT | NULL | - | - | Источник данных (система-источник) |

hub_shipment
| Имя поля | Тип данных | Обязательность | Значение по умолчанию | Партицирование | Бизнес-описание |
|----------|------------|----------------|----------------------|----------------|-----------------|
| shipment_sk | TEXT | NOT NULL | - | - | Суррогатный ключ отгрузки (хэш бизнес-ключа) |
| shipment_id | INT | NULL | - | - | Идентификатор отгрузки из исходной системы |
| load_datetime | TIMESTAMP | NULL | CURRENT_TIMESTAMP | - | Дата и время загрузки записи в хранилище |
| source | TEXT | NULL | - | - | Источник данных (система-источник) |

hub_customer
| Имя поля | Тип данных | Обязательность | Значение по умолчанию | Партицирование | Бизнес-описание |
|----------|------------|----------------|----------------------|----------------|-----------------|
| customer_sk | TEXT | NOT NULL | - | - | Суррогатный ключ клиента (хэш бизнес-ключа) |
| customer_id | INT | NULL | - | - | Идентификатор клиента из исходной системы |
| load_datetime | TIMESTAMP | NULL | CURRENT_TIMESTAMP | - | Дата и время загрузки записи в хранилище |
| source | TEXT | NULL | - | - | Источник данных (система-источник) |

#### Таблицы Линки (Links)

link_sale_product
| Имя поля | Тип данных | Обязательность | Значение по умолчанию | Партицирование | Бизнес-описание |
|----------|------------|----------------|----------------------|----------------|-----------------|
| sale_product_sk | TEXT | NOT NULL | - | - | Суррогатный ключ связи продажа-продукт |
| sale_sk | TEXT | NOT NULL | - | - | Ссылка на суррогатный ключ продажи |
| product_sk | TEXT | NOT NULL | - | - | Ссылка на суррогатный ключ продукта |
| is_deleted | BOOLEAN | NULL | false | - | Признак удаленной связи (soft delete) |
| load_datetime | TIMESTAMP | NULL | CURRENT_TIMESTAMP | **Ключ партицирования** | Дата и время загрузки записи |
| source | TEXT | NULL | - | - | Источник данных (система-источник) |

link_sale_shipment
| Имя поля | Тип данных | Обязательность | Значение по умолчанию | Партицирование | Бизнес-описание |
|----------|------------|----------------|----------------------|----------------|-----------------|
| sale_shipment_sk | TEXT | NOT NULL | - | - | Суррогатный ключ связи продажа-отгрузка |
| sale_sk | TEXT | NOT NULL | - | - | Ссылка на суррогатный ключ продажи |
| shipment_sk | TEXT | NOT NULL | - | - | Ссылка на суррогатный ключ отгрузки |
| is_deleted | BOOLEAN | NULL | false | - | Признак удаленной связи (soft delete) |
| load_datetime | TIMESTAMP | NULL | CURRENT_TIMESTAMP | **Ключ партицирования** | Дата и время загрузки записи |
| source | TEXT | NULL | - | - | Источник данных (система-источник) |

link_sale_customer
| Имя поля | Тип данных | Обязательность | Значение по умолчанию | Партицирование | Бизнес-описание |
|----------|------------|----------------|----------------------|----------------|-----------------|
| sale_customer_sk | TEXT | NOT NULL | - | - | Суррогатный ключ связи продажа-клиент |
| sale_sk | TEXT | NOT NULL | - | - | Ссылка на суррогатный ключ продажи |
| customer_sk | TEXT | NOT NULL | - | - | Ссылка на суррогатный ключ клиента |
| is_deleted | BOOLEAN | NULL | false | - | Признак удаленной связи (soft delete) |
| load_datetime | TIMESTAMP | NULL | CURRENT_TIMESTAMP | **Ключ партицирования** | Дата и время загрузки записи |
| source | TEXT | NULL | - | - | Источник данных (система-источник) |

#### Таблицы Саттелиты (Satellites)

sat_sale_metrics
| Имя поля | Тип данных | Обязательность | Значение по умолчанию | Партицирование | Бизнес-описание |
|----------|------------|----------------|----------------------|----------------|-----------------|
| sale_sk | TEXT | NOT NULL | - | - | Ссылка на суррогатный ключ продажи |
| load_datetime | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | - | Дата и время загрузки записи в хранилище |
| source | TEXT | NULL | - | - | Источник данных (система-источник) |
| sales | DECIMAL(15,2) | NULL | - | - | Сумма продажи в денежном выражении |
| quantity | INT | NULL | - | - | Количество проданных единиц |
| discount | DECIMAL(5,2) | NULL | - | - | Размер скидки в процентах или абсолютном значении |
| profit | DECIMAL(15,2) | NULL | - | - | Прибыль от продажи |
| effective_from | DATE | NULL | CURRENT_DATE | **Ключ партицирования** | Дата начала действия версии атрибутов |
| effective_to | DATE | NULL | '9999-12-31' | - | Дата окончания действия версии атрибутов |
| hash_diff | TEXT | NULL | - | - | Хэш-разница всех атрибутов для отслеживания изменений |

sat_product_category
| Имя поля | Тип данных | Обязательность | Значение по умолчанию | Партицирование | Бизнес-описание |
|----------|------------|----------------|----------------------|----------------|-----------------|
| product_sk | TEXT | NOT NULL | - | - | Ссылка на суррогатный ключ продукта |
| load_datetime | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | - | Дата и время загрузки записи в хранилище |
| source | TEXT | NULL | - | - | Источник данных (система-источник) |
| category | TEXT | NULL | - | **Под-партиция** | Основная категория продукта |
| sub_category | TEXT | NULL | - | - | Подкатегория продукта |
| effective_from | DATE | NULL | CURRENT_DATE | **Ключ партицирования** | Дата начала действия версии атрибутов |
| effective_to | DATE | NULL | '9999-12-31' | - | Дата окончания действия версии атрибутов |
| hash_diff | TEXT | NULL | - | - | Хэш-разница всех атрибутов для отслеживания изменений |

sat_shipment_mode
| Имя поля | Тип данных | Обязательность | Значение по умолчанию | Партицирование | Бизнес-описание |
|----------|------------|----------------|----------------------|----------------|-----------------|
| shipment_sk | TEXT | NOT NULL | - | - | Ссылка на суррогатный ключ отгрузки |
| load_datetime | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | - | Дата и время загрузки записи в хранилище |
| source | TEXT | NULL | - | - | Источник данных (система-источник) |
| ship_mode | TEXT | NULL | - | **Под-партиция** | Режим/способ доставки отгрузки |
| effective_from | DATE | NULL | CURRENT_DATE | **Ключ партицирования** | Дата начала действия версии атрибутов |
| effective_to | DATE | NULL | '9999-12-31' | - | Дата окончания действия версии атрибутов |
| hash_diff | TEXT | NULL | - | - | Хэш-разница всех атрибутов для отслеживания изменений |

sat_customer_region
| Имя поля | Тип данных | Обязательность | Значение по умолчанию | Партицирование | Бизнес-описание |
|----------|------------|----------------|----------------------|----------------|-----------------|
| customer_sk | TEXT | NOT NULL | - | - | Ссылка на суррогатный ключ клиента |
| load_datetime | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | - | Дата и время загрузки записи в хранилище |
| source | TEXT | NULL | - | - | Источник данных (система-источник) |
| country | TEXT | NULL | - | - | Страна местонахождения клиента |
| region | TEXT | NULL | - | - | Регион местонахождения клиента |
| state | TEXT | NULL | - | - | Штат/область местонахождения клиента |
| city | TEXT | NULL | - | - | Город местонахождения клиента |
| postal_code | INT | NULL | - | - | Почтовый индекс клиента |
| effective_from | DATE | NULL | CURRENT_DATE | **Ключ партицирования** | Дата начала действия версии атрибутов |
| effective_to | DATE | NULL | '9999-12-31' | - | Дата окончания действия версии атрибутов |
| hash_diff | TEXT | NULL | - | - | Хэш-разница всех атрибутов для отслеживания изменений |

sat_customer_segment
| Имя поля | Тип данных | Обязательность | Значение по умолчанию | Партицирование | Бизнес-описание |
|----------|------------|----------------|----------------------|----------------|-----------------|
| customer_sk | TEXT | NOT NULL | - | - | Ссылка на суррогатный ключ клиента |
| load_datetime | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | - | Дата и время загрузки записи в хранилище |
| source | TEXT | NULL | - | - | Источник данных (система-источник) |
| segment | TEXT | NULL | - | | Сегмент клиента (Consumer/Corporate/Home Office) |
| effective_from | DATE | NULL | CURRENT_DATE | **Ключ партицирования** | Дата начала действия версии атрибутов |
| effective_to | DATE | NULL | '9999-12-31' | - | Дата окончания действия версии атрибутов |
| hash_diff | TEXT | NULL | - | - | Хэш-разница всех атрибутов для отслеживания изменений |

### Технические особенности

#### Оптимизация для Greenplum

**Распределение таблиц:**
- Хабы → по хеш-ключу
- Линки → по ссылке на хэш ключ хаба продаж (sale_sk), так как по нему делаем наиболее частый join
- Сателлиты → по родительскому хеш-ключу

**Партицирование:**
- Хабы без партицирования
- Линки с партицированием по дате загрузки
- Все сателлиты содержат партиции по effective_from, effective_to, так как всегда отбираем определенные бизнес даты. Таблицы sat_shipment_mode и sat_product_category также партицированы по полям category и ship_mode, тк они часто используются при фильтрации.

**Ориентация таблиц:**
- Все хабы append optimized с хранением по строкам
- Все линки append optimized с хранением по строкам
- Все сателлиты append optimized с хранением по столбцам, так из сателлита чаще всего отбирается меньшая часть его атрибутов
